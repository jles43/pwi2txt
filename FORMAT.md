# Исследование формата файла

## Заголовок файла

Начало у всех имеющихся файлов было одинаково, вплоть до позиции `000000f4`. В одном файле в этой позиции стоял байт `17`,
во всех остальных - байт `00`. Значение этого байта пока неизвестно.

Основные различия файлов начинаются с позиции `0000012c`.

В позиции `0000012e` записано число строк. Это имеет место во всех имеющихся файлах. То же число (во всех файлах)
записано и в позиции `00000132`. Длина поля, скорее всего, 4 байта.

## Где находится текст

Текст находится в строках. Перед первой строкой в каждом файле замечена последовательность из байта `22` и 15 нулей.
Каждая строка содержит текст и метки формата, начинается с некоторой метки формата и заканчивается байтовой последовательностью
`c4 00 00` (LINE_END). Каждая метка формата имеет длину 3 байта, как и LINE_END.
После LINE_END расположена некоторая ещё не определённая структура, возможно, данные о форматировании строки, начинающаяся с байтовой
последовательности `42 00` (пока обозначим её LINE_FORMAT). Начало строки и LINE_FORMAT выравнены на границу 4 байт.

Начало следующей строки находится минимум в 48 байтах (`0x30`) от позиции LINE_FORMAT, иногда расстояние составляет 56 байт (`0x38`).
Один раз была замечена метка FORMAT1_ON (см.ниже), стоящая отдельно и без текста, через 52 байта (`0x34`) от позиции LINE_FORMAT.
В 16 байтах от позиции FORMAT1_ON, и в 68 байтах (`0x44`) от LINE_FORMAT был реальное начало строки с метками FORMAT1_ON+FORMAT2_ON,
за которыми следовал текст.

### Обнаруженные метки формата

|Метка|Байты|
|-----|-----|
|FORMAT1_ON|e5 01 00|
|FORMAT1_OFF|e5 00 00|
|FORMAT2_ON|e6 0a 00|
|FORMAT2_OFF|e6 00 00|

Ни одна OFF-метка не замечена в начале строки, любая метка, как *ON, так и *OFF, может появиться в тексте до LINE_END.

## Как кодируется ASCII

Символы из нижней половины кодовой страницы (с кодами меньше 128) кодируются одним байтом, т.е., например, пробел
представлен байтом `20`, буква "g" - байтом `67`, и т.д.

## Как кодируются умляуты и символы из других языков

Умляуты кодируются двумя байтами:

|Буква|UTF-8|PWI|
|:---:|:----|:--|
|Ä|c3 84||
|Ö|c3 96||
|Ü|c3 9c||
|ß|c3 9f|c1 df|
|ä|c3 a4|c1 e4|
|ö|c3 b6||
|ü|c3 bc|c1 fc|

В двоичном представлении байты выглядят:

    c3 bc 11000011 10111100
    c1 fc 11000001 11111100

    c3 9f 11000011 10011111
    c1 df 11000001 11011111
    
Похоже, что в первом байте нужно установить 1-ый бит, а во втором - обнулить 6-ой бит.
Практика показала, что особые символы из других языков тоже декодируются нормально.
Следует однако заметить, что символы "Œ" и "œ" (UTF-8 соответственно `c5 92` и `c5 93`) кодируются
как `92 05` и `93 05`, т.е. по правилам кириллицы (см. ниже).

|Буква|UTF-8|PWI|
|:---:|:----|:--|
|À|c3 80|c1 c0|
|Á|c3 81|c1 c1|
|Â|c3 82|c1 c2|
|Ã|c3 83|c1 c3|
|Å|c3 85|c1 c5|
|Æ|c3 86|c1 c6|
|Ç|c3 87|c1 c7|
|È|c3 88|c1 c8|
|É|c3 89|c1 c9|
|Ê|c3 8a|c1 ca|
|Ë|c3 8b|c1 cb|
|Ì|c3 8c|c1 cc|
|Í|c3 8d|c1 cd|
|Î|c3 8e|c1 ce|
|Ï|c3 8f|c1 cf|
|Ð|c3 90|c1 d0|
|Ñ|c3 91|c1 d1|
|Ò|c3 92|c1 d2|
|Ó|c3 93|c1 d3|
|Ô|c3 94|c1 d4|
|Õ|c3 95|c1 d5|
|Ø|c3 98|c1 d8|
|Ù|c3 99|c1 d9|
|Ú|c3 9a|c1 da|
|Û|c3 9b|c1 db|
|Ý|c3 9d|c1 dd|
|Þ|c3 9e|c1 de|
|à|c3 a0|c1 e0|
|á|c3 a1|c1 e1|
|â|c3 a2|c1 e2|
|ã|c3 a3|c1 e3|
|å|c3 a5|c1 e5|
|æ|c3 a6|c1 e6|
|ç|c3 a7|c1 e7|
|è|c3 a8|c1 e8|
|é|c3 a9|c1 e9|
|ê|c3 aa|c1 ea|
|ë|c3 ab|c1 eb|
|ì|c3 ac|c1 ec|
|í|c3 ad|c1 ed|
|î|c3 ae|c1 ee|
|ï|c3 af|c1 ef|
|ð|c3 b0|c1 f0|
|ñ|c3 b1|c1 f1|
|ò|c3 b2|c1 f2|
|ó|c3 b3|c1 f3|
|ô|c3 b4|c1 f4|
|õ|c3 b5|c1 f5|
|ø|c3 b8|c1 f8|
|ù|c3 b9|c1 f9|
|ú|c3 ba|c1 fa|
|û|c3 bb|c1 fb|
|ý|c3 bd|c1 fd|
|þ|c3 be|c1 fe|
|ÿ|c3 bf||
|Œ|c5 92|92 05|
|œ|c5 93|93 05|


## Как кодируются другие знаки

|Буква|UTF-8|PWI|
|:---:|:----|:--|
|¡|c2 a1|c1 a1|
|¢|c2 a2|c1 a2|
|£|c2 a3|c1 a3|
|¤|c2 a4|c1 a4|
|¥|c2 a5|c1 a5|
|¦|c2 a6||
|§|c2 a7||
|¨|c2 a8||
|©|c2 a9||
|ª|c2 aa||
|«|c2 ab||
|¬|c2 ac||
|®|c2 ae||
|¯|c2 af||
|°|c2 b0|c1 b0|
|±|c2 b1||
|²|c2 b2|c1 b2|
|³|c2 b3|c1 b3|
|´|c2 b4|c1 b4|
|µ|c2 b5||
|¶|c2 b6|c1 b6|
|·|c2 b7||
|¸|c2 b8||
|¹|c2 b9||
|º|c2 ba||
|»|c2 bb||
|¼|c2 bc||
|½|c2 bd||
|¾|c2 be||
|¿|c2 bf|c1 bf|
|×|c3 97||
|÷|c3 b7||
|€|e2 82 ac|ac 82|


Предположительно, все знаки в пределах `c1 b0..bf` соответствуют кодам UTF-8 `c2 b0..bf`.

## Как кодируется кириллица

Каждый символ кириллицы кодируется двумя байтами. Буква "В" представлена байтами `92 10`, буква "е" - байтами `b5 10`,
буква "н" - `bd 10`, "у" - `83 11`, и т.д.

Кириллические буквы сведены в таблицу, в столбце PWI записаны байтовые последовательности букв, которые присутствовали
в имеющихся экземплярах файлов .PWI. Довольно очевидно следующее:

* первый байт из кодировки PWI совпадает со вторым байтом UTF-8

* второй байт из кодировки PWI в младших 6 битах совпадает с первым байтом UTF-8

* старшие два бита второго байта PWI-кодировки равны нулю, старшие 2 бита первого байта кодировки UTF-8 равны единице

Предположительно, то же самое действует для всех знаков, у которых второй байт равен
от `04` до `1f`.

|Буква|UTF-8|PWI|
|:---:|:----|:--|
|А|d0 90||
|Б|d0 91||
|В|d0 92|92 10|
|Г|d0 93||
|Д|d0 94||
|Е|d0 95||
|Ж|d0 96||
|З|d0 97||
|И|d0 98||
|Й|d0 99||
|К|d0 9a||
|Л|d0 9b||
|М|d0 9c||
|Н|d0 9d||
|О|d0 9e||
|П|d0 9f||
|Р|d0 a0||
|С|d0 a1||
|Т|d0 a2||
|У|d0 a3||
|Ф|d0 a4||
|Х|d0 a5||
|Ц|d0 a6||
|Ч|d0 a7||
|Ш|d0 a8||
|Щ|d0 a9||
|Ъ|d0 aa||
|Ы|d0 ab||
|Ь|d0 ac||
|Э|d0 ad||
|Ю|d0 ae||
|Я|d0 af||
|а|d0 b0|b0 10|
|б|d0 b1|b1 10|
|в|d0 b2|b2 10|
|г|d0 b3||
|д|d0 b4|b4 10|
|е|d0 b5|b5 10|
|ж|d0 b6|b6 10|
|з|d0 b7|b7 10|
|и|d0 b8|b8 10|
|й|d0 b9|b9 10|
|к|d0 ba|ba 10|
|л|d0 bb|bb 10|
|м|d0 bc||
|н|d0 bd|bd 10|
|о|d0 be|be 10|
|п|d0 bf||
|р|d1 80|80 11|
|с|d1 81|81 11|
|т|d1 82|82 11|
|у|d1 83|83 11|
|ф|d1 84|84 11|
|х|d1 85||
|ц|d1 86||
|ч|d1 87||
|ш|d1 88||
|щ|d1 89||
|ъ|d1 8a||
|ы|d1 8b||
|ь|d1 8c||
|э|d1 8d||
|ю|d1 8e|8e 11|
|я|d1 8f||
|Ё|d0 81||
|ё|d1 91|91 11|
